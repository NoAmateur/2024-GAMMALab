# ä¸‰ç§å¸¸è§å›¾ç¥ç»ç½‘ç»œä»£ç ä¸å…¬å¼å¯¹åº”å…³ç³»

## å®ç°GATConv
### å›¾æ³¨æ„åŠ›ç½‘ç»œï¼ˆGATï¼‰çš„å…³é”®å…¬å¼å¦‚ä¸‹ï¼š
```

eijâ€‹=LeakyReLU(aT[Whiâ€‹âˆ¥Whjâ€‹])

ğ›¼ğ‘–ğ‘—=softmaxğ‘—(ğ‘’ğ‘–ğ‘—)=expâ¡(ğ‘’ğ‘–ğ‘—)âˆ‘ğ‘˜âˆˆğ‘(ğ‘–)expâ¡(ğ‘’ğ‘–ğ‘˜)

â„ğ‘–â€²=ğœ(âˆ‘ğ‘—âˆˆğ‘(ğ‘–)ğ›¼ğ‘–ğ‘—ğ‘Šâ„ğ‘—)
```
### ä»£ç å®ç°å¦‚ä¸‹ï¼š
#### åŸºäºPyG:
```JavaScript
class PyG_GATConv(MessagePassing):
    def __init__(self, in_channel, out_channel):
        super(PyG_GATConv, self).__init__(aggr='add')
        self.lin = nn.Linear(in_channel, out_channel, bias=False)  # å®šä¹‰çº¿æ€§å˜æ¢å±‚ (1)å¯¹åº”å…¬å¼ï¼šh'_i=Wh_i
        self.att = nn.Parameter(torch.Tensor(1, out_channel))  # å®šä¹‰æ³¨æ„åŠ›å‚æ•° (2)   å¯¹åº”å…¬å¼eijâ€‹=LeakyReLU(aT[Whiâ€‹âˆ¥Whjâ€‹])
        self.reset_parameters()  # åˆå§‹åŒ–å‚æ•° (3) 

    def reset_parameters(self):
        nn.init.xavier_uniform_(self.lin.weight)  # åˆå§‹åŒ–çº¿æ€§å˜æ¢æƒé‡ (3)  å³W
        nn.init.xavier_uniform_(self.att)  # åˆå§‹åŒ–æ³¨æ„åŠ›æƒé‡ (4) å³a

    def forward(self, x, edge_index):
        edge_index, _ = add_self_loops(edge_index, num_nodes=x.size(0))  # å¢åŠ è‡ªç¯ (5)
        x = self.lin(x)  # åº”ç”¨çº¿æ€§å˜æ¢ (6) hiâ€²=Whi
        alpha = (x @ self.att.t()).squeeze(-1)  # è®¡ç®—æ³¨æ„åŠ›ç³»æ•° (7)
        ptr = torch.arange(x.size(0) + 1, dtype=torch.long, device=edge_index.device)  # åˆ›å»º ptr ç´¢å¼• (8)
        return self.propagate(edge_index, x=x, alpha=alpha, ptr=ptr)  # è°ƒç”¨ message passing (9)  

    def message(self, x_j, alpha_j, index, ptr, size_i):
        alpha = softmax(alpha_j, index)  # è®¡ç®— softmax æ³¨æ„åŠ›ç³»æ•° (10)
        return x_j * alpha.view(-1, 1)  # æ¶ˆæ¯ä¼ é€’å¹¶åŠ æƒ (11)

    def update(self, aggr_out):
        return aggr_out  # æ›´æ–°èŠ‚ç‚¹ç‰¹å¾ (12)
  ```
#### åŸºäºDGLï¼š
```JavaScript
class DGL_GATConv(nn.Module):
    def __init__(self, in_channel, out_channel):
        super(DGL_GATConv, self).__init__()
        self.in_channel = in_channel
        self.out_channel = out_channel
        self.W = nn.Parameter(torch.Tensor(in_channel, out_channel))  # (2)
        self.att = nn.Parameter(torch.Tensor(1, out_channel))  # (3)
        self.reset_parameters()

    def reset_parameters(self):
        nn.init.xavier_uniform_(self.W)  # åˆå§‹åŒ–æƒé‡çŸ©é˜µW (2)
        nn.init.xavier_uniform_(self.att)  # åˆå§‹åŒ–æ³¨æ„åŠ›æƒé‡å‘é‡att (3)

    def forward(self, g, h):
        with g.local_scope():  # ä½¿ç”¨å±€éƒ¨èŒƒå›´ï¼Œé¿å…å½±å“åŸå›¾ (1)
            h = torch.matmul(h, self.W)  # èŠ‚ç‚¹ç‰¹å¾çš„çº¿æ€§å˜æ¢ (4)
            g.ndata['h'] = h  # å°†çº¿æ€§å˜æ¢åçš„ç‰¹å¾å­˜å‚¨åœ¨å›¾çš„èŠ‚ç‚¹æ•°æ®ä¸­ (5)
            g.ndata['a'] = torch.matmul(h, self.att.t())  # è®¡ç®—æ³¨æ„åŠ›åˆ†æ•° (6)
            g.apply_edges(fn.u_add_v('a', 'a', 'e'))  # è®¡ç®—è¾¹ä¸Šçš„æ³¨æ„åŠ›åˆ†æ•° (7)
            e = torch.exp(g.edata.pop('e'))  # å¯¹æ³¨æ„åŠ›åˆ†æ•°å–æŒ‡æ•° (8)
            g.edata['a'] = dgl.ops.edge_softmax(g, e)  # è¿›è¡Œsoftmaxå½’ä¸€åŒ– (9)
            g.update_all(fn.u_mul_e('h', 'a', 'm'), fn.sum('m', 'h'))  # æ¶ˆæ¯ä¼ é€’ä¸èšåˆ (10)
            return g.ndata.pop('h')  # è¿”å›æ›´æ–°åçš„èŠ‚ç‚¹ç‰¹å¾ (11)
```
  ## å®ç°SAGEConv
### å›¾æ³¨æ„åŠ›ç½‘ç»œï¼ˆGATï¼‰çš„å…³é”®å…¬å¼å¦‚ä¸‹ï¼š
1.  **çº¿æ€§å˜æ¢èŠ‚ç‚¹ç‰¹å¾**: 
é¦–å…ˆï¼Œå¯¹èŠ‚ç‚¹ç‰¹å¾è¿›è¡Œçº¿æ€§å˜æ¢ï¼š
    
    

> â„ğ‘–â€²=ğ‘Šâ„ğ‘–

    
    å…¶ä¸­ï¼Œğ‘Š æ˜¯æƒé‡çŸ©é˜µï¼Œâ„ğ‘– æ˜¯èŠ‚ç‚¹ ğ‘– çš„ç‰¹å¾ï¼Œâ„ğ‘–â€²â€‹ æ˜¯å˜æ¢åçš„ç‰¹å¾ã€‚
    
2.  **èšåˆé‚»å±…èŠ‚ç‚¹ç‰¹å¾**: 
ä½¿ç”¨æŸç§èšåˆå‡½æ•°ï¼ˆå¦‚å‡å€¼ã€æœ€å¤§å€¼ã€LSTMç­‰ï¼‰å¯¹èŠ‚ç‚¹ ğ‘– çš„é‚»å±…èŠ‚ç‚¹ç‰¹å¾è¿›è¡Œèšåˆï¼š
    

>     â„ğ‘–agg=AGGREGATEğ‘—âˆˆğ‘(ğ‘–)(â„ğ‘—â€²)

    
    å…¶ä¸­ï¼Œğ‘(ğ‘–) è¡¨ç¤ºèŠ‚ç‚¹ ğ‘– çš„é‚»å±…èŠ‚ç‚¹é›†åˆï¼ŒAGGREGATE æ˜¯èšåˆå‡½æ•°ï¼Œâ„ğ‘–agghiaggâ€‹ æ˜¯èšåˆåçš„é‚»å±…ç‰¹å¾ã€‚
    
3.  **ç»“åˆè‡ªèº«ç‰¹å¾å’Œé‚»å±…ç‰¹å¾**: å°†èŠ‚ç‚¹ ğ‘–i è‡ªèº«çš„ç‰¹å¾å’Œå…¶é‚»å±…èŠ‚ç‚¹çš„èšåˆç‰¹å¾ç»“åˆåœ¨ä¸€èµ·ï¼Œå¹¶è¿›è¡Œè¿›ä¸€æ­¥å˜æ¢ï¼š
    
   

>  â„ğ‘–new=ğœ(ğ‘Šcombine[â„ğ‘–âˆ¥â„ğ‘–agg])

    
    å…¶ä¸­ï¼Œğ‘Šcombineâ€‹ æ˜¯å¦ä¸€ä¸ªæƒé‡çŸ©é˜µï¼Œâˆ¥ è¡¨ç¤ºç‰¹å¾æ‹¼æ¥ï¼Œğœ æ˜¯æ¿€æ´»å‡½æ•°ï¼ˆå¦‚ReLUç­‰ï¼‰ï¼Œâ„ğ‘–new æ˜¯æ›´æ–°åçš„ç‰¹å¾ã€‚
    

### ä»£ç å®ç°å¦‚ä¸‹ï¼š

#### åŸºäºPyGï¼š
```JavaScript
class PyG_SAGEConv(MessagePassing):
    def __init__(self, in_channels, out_channels):
        super(PyG_SAGEConv, self).__init__(aggr='mean')  # å®šä¹‰èšåˆå‡½æ•°ä¸ºå¹³å‡å€¼ (1)
        self.lin = nn.Linear(in_channels, out_channels)  # å®šä¹‰çº¿æ€§å˜æ¢å±‚ (2)
        self.update_lin = nn.Linear(in_channels, out_channels)  # å®šä¹‰æ›´æ–°å±‚ (3)

    def forward(self, x, edge_index):
        edge_index, _ = add_self_loops(edge_index, num_nodes=x.size(0))  # å¢åŠ è‡ªç¯ (4)
        x = self.lin(x)  # åº”ç”¨çº¿æ€§å˜æ¢ (5)
        return self.propagate(edge_index, x=x)  # è°ƒç”¨æ¶ˆæ¯ä¼ é€’ (6)

    def message(self, x_j):
        return x_j  # æ¶ˆæ¯ä¼ é€’ï¼Œç›´æ¥è¿”å›é‚»å±…èŠ‚ç‚¹çš„ç‰¹å¾ (7)

    def update(self, aggr_out, x):
        combined = torch.cat([x, aggr_out], dim=-1)  # å°†ä¸­å¿ƒèŠ‚ç‚¹ç‰¹å¾ä¸èšåˆç‰¹å¾æ‹¼æ¥ (8)
        return self.update_lin(combined)  # åº”ç”¨æ›´æ–°å±‚è¿›è¡Œç‰¹å¾æ›´æ–° (9)
  ```
#### åŸºäºDGLï¼š
```JavaScript
class DGL_SAGEConv(nn.Module):
    def __init__(self, in_channel, out_channel):
        super(DGL_SAGEConv, self).__init__()
        self.in_channel = in_channel
        self.out_channel = out_channel
        self.W = nn.Linear(in_channel, out_channel)  # å®šä¹‰çº¿æ€§å˜æ¢çŸ©é˜µW (2)
        self.update_lin = nn.Linear(in_channel + out_channel, out_channel)  # å®šä¹‰ç”¨äºæ›´æ–°ç‰¹å¾çš„çº¿æ€§å˜æ¢çŸ©é˜µ (8)

    def forward(self, g, h):
        with g.local_scope():  # åœ¨å±€éƒ¨èŒƒå›´å†…æ“ä½œï¼Œé˜²æ­¢æ”¹å˜åŸå›¾ç»“æ„ (1)
            h_in = h  # ä¿å­˜è¾“å…¥ç‰¹å¾ä»¥ä¾¿ä¹‹åæ‹¼æ¥ (7)
            h = self.W(h)  # èŠ‚ç‚¹ç‰¹å¾çš„çº¿æ€§å˜æ¢ (2)
            g.ndata['h'] = h  # å°†çº¿æ€§å˜æ¢åçš„ç‰¹å¾å­˜å‚¨åœ¨å›¾çš„èŠ‚ç‚¹æ•°æ®ä¸­ (3)
            g.update_all(fn.copy_u('h', 'm'), fn.mean('m', 'h'))  # èšåˆé‚»å±…ç‰¹å¾ (4) (5)
            h = g.ndata.pop('h')  # è·å–èšåˆåçš„ç‰¹å¾ (6)
            return self.update_lin(torch.cat([h_in, h], dim=1))  # æ‹¼æ¥è¾“å…¥ç‰¹å¾å’Œèšåˆç‰¹å¾ï¼Œå¹¶è¿›è¡Œçº¿æ€§å˜æ¢ (8)
 ```

